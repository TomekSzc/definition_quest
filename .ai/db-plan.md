# Definition Quest – Database Schema

## 1. Tables

### 1.1 `auth.users` (managed by Supabase Auth)
This table is **fully maintained by Supabase Auth**—the application never writes directly to it. Below are only the columns that our code reads or joins on:
| column | type | constraints |
| ------ | ---- | ----------- |
| id | uuid | **PK** generated by Supabase Auth |
| email | text | **UNIQUE**, **NOT NULL** – user login identifier |
| created_at | timestamptz | DEFAULT now() – row creation time |
| confirmed_at | timestamptz |  | NULL until email is confirmed |
| encrypted_password | text | **NOT NULL** – salted & hashed password |

> Supabase manages many additional auth-related columns (tokens, factors, etc.) that are outside of the application scope.

---

### 1.2 `user_meta`
| column | type | constraints | description |
| ------ | ---- | ----------- | ----------- |
| id | uuid | **PK**, **FK** → `auth.users(id)` **NOT NULL** | mirrors user id (1-to-1) |
| display_name | text | **NOT NULL**, CHECK (length(display_name) ≤ 40) | public nickname |
| avatar_url | text |  | optional avatar |
| created_at | timestamptz | DEFAULT now() | row creation time |

Indexes:
* PK on `id` (implicit).

---

### 1.3 `boards`
| column | type | constraints | description |
| ------ | ---- | ----------- | ----------- |
| id | uuid | **PK** DEFAULT gen_random_uuid() |
| owner_id | uuid | **FK** → `auth.users(id)` **NOT NULL** |
| title | text | **NOT NULL** |
| card_count | smallint | **NOT NULL**, CHECK (card_count IN (16,24)) |
| level | smallint | **NOT NULL**, CHECK (level ≥ 1) | sequence number for multi-page boards |
| is_public | boolean | DEFAULT false **NOT NULL** |
| archived | boolean | DEFAULT false **NOT NULL** |
| tags | text[] | DEFAULT '{}'::text[], CHECK (array_length(tags,1) ≤ 10 AND (SELECT bool_and(length(t) ≤ 20) FROM unnest(tags) t)) | max 10 tags, each ≤ 20 chars |
| search_vector | tsvector | GENERATED ALWAYS AS (to_tsvector('simple', coalesce(title,'') )) STORED |
| created_at | timestamptz | DEFAULT now() |
| updated_at | timestamptz | DEFAULT now() |

Constraints:
* UNIQUE (owner_id, title, level) – prevents duplicate titles per level for one user.

Indexes:
* PK on `id` (implicit)
* BTREE on `(owner_id)`
* BTREE on `(is_public, archived, owner_id)` – speeds up list queries
* GIN on `search_vector` – full-text search
* GIN on `tags`

---

### 1.4 `pairs`
| column | type | constraints | description |
| ------ | ---- | ----------- | ----------- |
| id | uuid | **PK** DEFAULT gen_random_uuid() |
| board_id | uuid | **FK** → `boards(id)` ON DELETE CASCADE **NOT NULL** |
| term | text | **NOT NULL** |
| definition | text | **NOT NULL** |
| created_at | timestamptz | DEFAULT now() |

Constraints:
* UNIQUE (board_id, term) – eliminates duplicate terms per board.

Indexes:
* PK on `id`
* BTREE on `(board_id)`

---

### 1.5 `scores`
| column | type | constraints | description |
| ------ | ---- | ----------- | ----------- |
| id | uuid | **PK** DEFAULT gen_random_uuid() |
| user_id | uuid | **FK** → `auth.users(id)` **NOT NULL** |
| board_id | uuid | **FK** → `boards(id)` **NOT NULL** |
| elapsed_ms | integer | **NOT NULL**, CHECK (elapsed_ms > 0) | best time in milliseconds |
| played_at | timestamptz | DEFAULT now() |

Constraints:
* UNIQUE (user_id, board_id) – keeps only best time per user & board.

Indexes:
* PK on `id`
* BTREE on `(board_id)`
* BTREE on `(user_id)`

---

### 1.6 `ai_requests`
| column | type | constraints | description |
| ------ | ---- | ----------- | ----------- |
| id | uuid | **PK** DEFAULT gen_random_uuid() |
| user_id | uuid | **FK** → `auth.users(id)` **NOT NULL** |
| requested_at | timestamptz | DEFAULT now() |
| model | text | **NOT NULL** |
| prompt_tokens | integer | **NOT NULL** |
| cost_usd | numeric(10,4) | **NOT NULL** |
| status | text | **NOT NULL** | e.g. `ok`, `error` |

Indexes:
* PK on `id`
* BTREE on `(user_id, requested_at)`

---

### 1.7 Materialized Views
| view | definition | refresh strategy |
| ---- | ---------- | ---------------- |
| `daily_ai_usage` | SELECT user_id, date_trunc('day', requested_at) AS request_date, count(*) AS cnt FROM ai_requests GROUP BY 1,2 | refreshed nightly via Supabase cron; supports 50-per-day limit |
| `best_scores` | SELECT user_id, board_id, MIN(elapsed_ms) AS best_time FROM scores GROUP BY 1,2 | refreshed on ‑commit (`ON COMMIT REFRESH`) |

---

## 2. Relationships
* **`auth.users` 1-to-1 `user_meta`** via identical primary keys.
* **`auth.users` 1-to-many `boards`** (`owner_id`).
* **`boards` 1-to-many `pairs`** (`board_id`).
* **`auth.users` 1-to-many `scores`** (`user_id`).
* **`boards` 1-to-many `scores`** (`board_id`).
* **`auth.users` 1-to-many `ai_requests`** (`user_id`).

No many-to-many tables are required in the MVP.

---

## 3. Index Summary
* `boards`: PK `id`, BTREE `(owner_id)`, BTREE `(is_public, archived, owner_id)`, GIN `search_vector`, GIN `tags`.
* `pairs`: PK `id`, BTREE `(board_id)`.
* `scores`: PK `id`, UNIQUE `(user_id, board_id)`, BTREE `(board_id)`, BTREE `(user_id)`.
* `ai_requests`: PK `id`, BTREE `(user_id, requested_at)`.
* Additional implicit PK indexes on all tables using UUID primary keys.

---

## 4. Row-Level Security (RLS)
RLS is **enabled** on every user-facing table. Example policies use PostgreSQL helper function `auth.uid()` provided by Supabase.

### 4.1 `boards`
* Policy **owner_full_access**: (`auth.uid() = owner_id`) – ALLOW ALL.
* Policy **public_read**: (`is_public = true AND archived = false`) – ALLOW SELECT.
* Deny by default. Anonymous role has no policies → no access.

### 4.2 `pairs`
* Policy **board_owner_or_public**: `EXISTS (SELECT 1 FROM boards b WHERE b.id = board_id AND (b.owner_id = auth.uid() OR (b.is_public AND NOT b.archived)))` – ALLOW SELECT.
* Policy **owner_write**: `EXISTS (SELECT 1 FROM boards b WHERE b.id = board_id AND b.owner_id = auth.uid())` – ALLOW INSERT, UPDATE, DELETE.

### 4.3 `scores`
* Policy **owner_full_access**: `auth.uid() = user_id` – ALLOW ALL.

### 4.4 `ai_requests`
* Policy **owner_full_access**: `auth.uid() = user_id` – ALLOW ALL.

### 4.5 `user_meta`
* Policy **owner_full_access**: `auth.uid() = id` – ALLOW ALL.

Service roles (e.g. `service_role`) bypass RLS for scheduled refreshes and internal maintenance.

---

## 5. Additional Notes
1. `gen_random_uuid()` from the `pgcrypto` extension is assumed to be enabled (`CREATE EXTENSION IF NOT EXISTS pgcrypto;`).
2. All timestamps use `timestamptz` to ensure timezone awareness.
3. No partitioning is applied at launch; monitor `ai_requests` & `scores` growth for future partitioning.
4. `search_vector` currently indexes only the board title; extend as needed (e.g. with owner display name) by altering the generated expression.
5. Materialized views should be refreshed via Supabase scheduled functions or external cron to keep limits and leaderboards current.


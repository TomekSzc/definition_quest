import { createClient } from "@supabase/supabase-js";
import type { Database } from "../../src/db/database.types";
import fs from "fs";
import path from "path";

/**
 * Global Teardown dla Playwright
 *
 * Ten skrypt uruchamia siƒô PO WSZYSTKICH testach E2E.
 * Czy≈õci bazƒô danych testowƒÖ z danych utworzonych podczas test√≥w.
 *
 * U≈ºywa klucza publicznego (SUPABASE_KEY) i loguje siƒô jako u≈ºytkownik testowy,
 * dziƒôki czemu respektuje Row Level Security (RLS) - bezpieczniejsze podej≈õcie.
 */

async function globalTeardown() {
  console.log("\nüßπ Starting E2E Global Teardown...");

  // Walidacja zmiennych ≈õrodowiskowych
  const supabaseUrl = process.env.SUPABASE_URL;
  const supabaseKey = process.env.SUPABASE_KEY;
  const testUserEmail = process.env.E2E_USERNAME;
  const testUserPassword = process.env.E2E_PASSWORD;

  if (!supabaseUrl) {
    console.error("‚ùå SUPABASE_URL not found in environment variables");
    console.log("   Make sure .env.test is configured properly");
    return;
  }

  if (!supabaseKey) {
    console.error("‚ùå SUPABASE_KEY not found in environment variables");
    console.log("   Public key is required for cleanup");
    return;
  }

  if (!testUserEmail || !testUserPassword) {
    console.error("‚ùå E2E_USERNAME or E2E_PASSWORD not found in environment variables");
    console.log("   Test user credentials are required for cleanup");
    return;
  }

  // Utw√≥rz klienta Supabase z kluczem publicznym (respektuje RLS)
  const supabase = createClient<Database>(supabaseUrl, supabaseKey, {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
  });

  try {
    console.log("üóëÔ∏è  Deleting test data from database...");

    // Zaloguj siƒô jako u≈ºytkownik testowy
    console.log(`   Logging in as test user: ${testUserEmail}`);
    const { data: authData, error: loginError } = await supabase.auth.signInWithPassword({
      email: testUserEmail,
      password: testUserPassword,
    });

    if (loginError || !authData.user) {
      console.error("‚ùå Error logging in as test user:", loginError?.message);
      console.log("   Make sure E2E_USERNAME and E2E_PASSWORD are correct");
      return;
    }

    const testUser = authData.user;
    console.log(`   ‚úÖ Logged in successfully (ID: ${testUser.id})`);

    // Usu≈Ñ dane w odpowiedniej kolejno≈õci (ze wzglƒôdu na foreign keys)
    // Teraz jeste≈õmy zalogowani jako u≈ºytkownik testowy, wiƒôc RLS pozwala na usuwanie

    // 1. Usu≈Ñ scores
    const { error: scoresError } = await supabase.from("scores").delete().eq("user_id", testUser.id);

    if (scoresError) {
      console.error("   ‚ö†Ô∏è  Error deleting scores:", scoresError.message);
    } else {
      console.log("   ‚úÖ Deleted scores for test user");
    }

    // 2. Usu≈Ñ ai_requests
    const { error: aiRequestsError } = await supabase.from("ai_requests").delete().eq("user_id", testUser.id);

    if (aiRequestsError) {
      console.error("   ‚ö†Ô∏è  Error deleting ai_requests:", aiRequestsError.message);
    } else {
      console.log("   ‚úÖ Deleted ai_requests for test user");
    }

    // 3. Pobierz boards u≈ºytkownika, ≈ºeby usunƒÖƒá pairs
    const { data: boards, error: boardsSelectError } = await supabase
      .from("boards")
      .select("id")
      .eq("owner_id", testUser.id);

    if (boardsSelectError) {
      console.error("   ‚ö†Ô∏è  Error fetching boards:", boardsSelectError.message);
    } else if (boards && boards.length > 0) {
      const boardIds = boards.map((b) => b.id);

      // 4. Usu≈Ñ pairs dla wszystkich boards u≈ºytkownika
      const { error: pairsError } = await supabase.from("pairs").delete().in("board_id", boardIds);

      if (pairsError) {
        console.error("   ‚ö†Ô∏è  Error deleting pairs:", pairsError.message);
      } else {
        console.log(`   ‚úÖ Deleted pairs for ${boards.length} board(s)`);
      }
    }

    // 5. Usu≈Ñ boards (kaskada usunie powiƒÖzane pairs je≈õli sƒÖ jakie≈õ pozosta≈Çe)
    const { error: boardsError } = await supabase.from("boards").delete().eq("owner_id", testUser.id);

    if (boardsError) {
      console.error("   ‚ö†Ô∏è  Error deleting boards:", boardsError.message);
    } else {
      console.log("   ‚úÖ Deleted boards for test user");
    }

    // 6. Usu≈Ñ user_meta
    const { error: userMetaError } = await supabase.from("user_meta").delete().eq("id", testUser.id);

    if (userMetaError) {
      console.error("   ‚ö†Ô∏è  Error deleting user_meta:", userMetaError.message);
    } else {
      console.log("   ‚úÖ Deleted user_meta for test user");
    }

    // Wyloguj siƒô
    await supabase.auth.signOut();

    console.log("‚úÖ E2E Global Teardown completed successfully\n");
  } catch (error) {
    console.error("‚ùå Error during global teardown:", error);
    // Nie rzucamy b≈Çƒôdu, ≈ºeby nie blokowaƒá raport√≥w testowych
  } finally {
    // Usu≈Ñ .env.local utworzony podczas test√≥w E2E
    const envLocalPath = path.resolve(process.cwd(), ".env.local");
    if (fs.existsSync(envLocalPath)) {
      fs.unlinkSync(envLocalPath);
      console.log("üßπ Cleaned up .env.local");
    }
  }
}

export default globalTeardown;
